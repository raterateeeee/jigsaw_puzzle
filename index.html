<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">

<title>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼å¤–æ ã¤ãï¼‰</title>
<style>
  body{font-family:sans-serif;text-align:center;background:#f5f5f5;margin:0;padding:20px}
  h1{font-size:28px;margin:20px 0 10px}
  .controls{margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
  button,input[type="file"]{margin:0 3px;padding:6px 10px;font-size:14px}
  #puzzle{position:relative;margin:0 auto}
  .tile{
    position:absolute;border:1px solid #ccc;box-sizing:border-box;
    background-size:cover;background-position:center;transition:left .2s, top .2s;cursor:pointer;
    width:100px;height:100px; /* JSã§ä¸Šæ›¸ã */
  }
</style>
</head>
<body>
<h1>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</h1>

<div class="controls">
  ã‚µã‚¤ã‚º:
  <button onclick="init(3)">3Ã—3</button>
  <button onclick="init(4)">4Ã—4</button>
  <button onclick="init(5)">5Ã—5</button>
  ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:
  <input id="fileInput" type="file" accept="image/*">
  <button onclick="shuffle()">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
</div>

<div id="puzzle"></div>

<script>
let N = 3;
let tileSize = 100;
let tileGap = 2;

let tiles = [];        // ã‚¿ã‚¤ãƒ«ã¯å¸¸ã« N*N æšï¼š{id, x, y, el}  id:0..N*N-1
let emptyPos = {x:0,y:0}; // ç©ºãã¯â€œåº§æ¨™â€ã§ç®¡ç†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä½œã‚‰ãªã„ï¼‰
let imgURL = null;     // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã®ObjectURL

const puzzle = document.getElementById('puzzle');
const fileInput = document.getElementById('fileInput');

/* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
fileInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(imgURL) URL.revokeObjectURL(imgURL);
  imgURL = URL.createObjectURL(f);
  // ç”»åƒãŒå…¥ã£ãŸã‚‰ç¾åœ¨ã‚µã‚¤ã‚ºã§ä½œã‚Šç›´ã—
  init(N);
});

/* åˆæœŸåŒ–ï¼šã‚¿ã‚¤ãƒ«ç”Ÿæˆã¯ NÃ—N æšã®ã¿ã€‚å¤–æ ã¯â€œä½ç½®â€ã§è¡¨ç¾ï¼ˆy=-1, x=N-1ï¼‰ */
function init(n){
  if(!imgURL){ alert('å…ˆã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'); return; }

  N = n;
  tiles = [];
  puzzle.innerHTML = '';

  // ç›¤ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ãƒ»åæ˜ 
  tileSize = 400 / N - tileGap;
  const w = N * (tileSize + tileGap);
  const h = (N + 1) * (tileSize + tileGap); // ä¸Šã«å¤–æ 1æ®µã¶ã‚“
  puzzle.style.width = w + 'px';
  puzzle.style.height = h + 'px';

  // NÃ—N ã‚¿ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆid ãŒå®Œæˆæ™‚ã®ä½ç½®ã‚’è¡¨ã™ï¼‰
  for(let y=0;y<N;y++){
    for(let x=0;x<N;x++){
      const id = y*N + x;
      const el = document.createElement('div');
      el.className = 'tile';
      el.style.width = tileSize + 'px';
      el.style.height = tileSize + 'px';
      el.addEventListener('click', ()=> onTileClick(id));
      puzzle.appendChild(el);
      tiles.push({id, x, y, el});
    }
  }

  // â˜…æœ€åˆã®ç©ºãã¯ã€Œå¤–ã¸å‡ºã—ãŸã‚¿ã‚¤ãƒ«ã®å…ƒã„ãŸå ´æ‰€ã€= å¸¸ã«1ã¤ã ã‘ã«ã™ã‚‹
  // ãƒ©ãƒ³ãƒ€ãƒ ã«1æšé¸ã‚“ã§å¤–æ (x=N-1, y=-1)ã¸ç§»å‹•ã—ã€ãã®å…ƒä½ç½®ã‚’ç©ºãã«è¨­å®š
  const pickIndex = (Math.random()*tiles.length)|0;
  const prev = { x: tiles[pickIndex].x, y: tiles[pickIndex].y };
  tiles[pickIndex].x = N-1; tiles[pickIndex].y = -1; // å¤–ã¸
  emptyPos = prev; // ç›¤å†…ã®ç©ºãã¯1ã¤ã ã‘

  render();
  // åˆæ³•æ‰‹ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  shuffle();
}

/* ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼šç©ºãã¨éš£æ¥ãªã‚‰å…¥æ›¿ãˆã‚‹ã€‚å¤–æ â‡„å³ä¸Šã‚»ãƒ«ã‚‚éš£æ¥æ‰±ã„ */
function onTileClick(id){
  const t = tiles.find(tt=>tt.id===id);
  if(!t || !imgURL) return;

  if(isNeighbor(t.x,t.y, emptyPos.x,emptyPos.y)){
    // swap åº§æ¨™
    const ox=t.x, oy=t.y;
    t.x = emptyPos.x; t.y = emptyPos.y;
    emptyPos = {x:ox, y:oy};
    render();
    if(isSolved()) alert('å®Œæˆï¼ğŸ‰');
  }
}

/* éš£æ¥åˆ¤å®šï¼šä¸Šä¸‹å·¦å³ã€‚ç‰¹æ®Šã‚±ãƒ¼ã‚¹ï¼šå¤–æ (N-1,-1) ã¨ å³ä¸Š(N-1,0) ã¯éš£æ¥ */
function isNeighbor(ax,ay, bx,by){
  if(ax===N-1 && ay===-1 && bx===N-1 && by===0) return true;
  if(bx===N-1 && by===-1 && ax===N-1 && ay===0) return true;
  return (Math.abs(ax-bx)+Math.abs(ay-by)===1);
}

/* ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šèƒŒæ™¯ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¯ id ã‚’åŸºæº–ã«åˆ‡ã‚Šå‡ºã™ï¼ˆé‡è¤‡ã—ãªã„ï¼‰ */
function render(){
  const bgW = N*tileSize + tileGap*(N-1);
  const bgH = N*tileSize + tileGap*(N-1);

  for(const t of tiles){
    // è¡¨ç¤ºä½ç½®ï¼ˆå¤–æ ã¯ä¸€æ®µä¸Šï¼šy=-1 â†’ top=0ï¼‰
    const left = t.x * (tileSize + tileGap);
    const top  = (t.y>=0 ? (t.y+1)*(tileSize+tileGap) : 0);
    t.el.style.left = left + 'px';
    t.el.style.top  = top  + 'px';

    // èƒŒæ™¯ã¯ id ã‚’ã‚‚ã¨ã«åˆ‡ã‚Šå‡ºã™ï¼ˆid ã¯ 0..N*N-1ï¼‰
    const wantX = (t.id % N) * (tileSize + tileGap);
    const wantY = Math.floor(t.id / N) * (tileSize + tileGap);
    t.el.style.backgroundImage = `url(${imgURL})`;
    t.el.style.backgroundSize  = `${bgW}px ${bgH}px`;
    t.el.style.backgroundPosition = `-${wantX}px -${wantY}px`;
  }

  // ç©ºãã‚»ãƒ«ã«ã¯ã‚¿ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ï¼è¦‹ãŸç›®ã§ç©´ã«ãªã‚‹ï¼ˆä½™è¨ˆãªâ€œç©ºã‚¿ã‚¤ãƒ«DOMâ€ã¯ä½œã‚‰ãªã„ï¼‰
}

/* åˆæ³•æ‰‹ã ã‘ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼šç©ºãã®ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯ï¼‹å¤–æ ã¨ã®å…¥æ›¿ãˆæ··ãœã‚‹ */
function shuffle(steps = (N===3?160 : N===4?240 : 320)){
  for(let i=0;i<steps;i++){
    // ç©ºãã«éš£æ¥ã™ã‚‹â€œç§»å‹•å¯èƒ½ã‚¿ã‚¤ãƒ«â€ã‚’åˆ—æŒ™
    const cand = tiles.filter(t => isNeighbor(t.x,t.y, emptyPos.x, emptyPos.y));
    if(!cand.length) continue;
    const pick = cand[(Math.random()*cand.length)|0];
    // ã‚¹ãƒ¯ãƒƒãƒ—
    const ox=pick.x, oy=pick.y;
    pick.x = emptyPos.x; pick.y = emptyPos.y;
    emptyPos = {x:ox, y:oy};
  }
  render();
  // ãŸã¾ãŸã¾å®Œæˆã—ã¦ã„ãŸã‚‰ã‚‚ã†å°‘ã—æ··ãœã‚‹
  if(isSolved()) shuffle(Math.floor(steps/3));
}

/* ã‚¯ãƒªã‚¢åˆ¤å®šï¼šç›¤å†…ãŒ id ã¨ä¸€è‡´ï¼†ç©ºããŒå¤–æ (N-1,-1) */
function isSolved(){
  // ç©ºããŒå¤–æ 
  if(!(emptyPos.x===N-1 && emptyPos.y===-1)) return false;
  // ç›¤å†…ã‚¿ã‚¤ãƒ«ãŒæ‰€å®šã®ä½ç½®
  for(const t of tiles){
    const wantX = t.id % N, wantY = Math.floor(t.id / N);
    if(t.x!==wantX || t.y!==wantY) return false;
  }
  return true;
}
</script>
</body>
</html>
